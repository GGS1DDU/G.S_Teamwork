package elms.data.financedata;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.util.ArrayList;
import java.util.Date;

import elms.dataservice.financedataservice.InitAllDataService;
import elms.po.AccountPO;
import elms.po.StoragePO;

public class InitAllData extends UnicastRemoteObject implements InitAllDataService{
   
    
     boolean initMember;
		boolean initStorage;
		boolean initAccount;
		boolean initCar;
    public InitAllData() throws RemoteException {
		super();
		// TODO 自动生成的构造函数存根
	}
   
    
    public static void main(String args[]) throws RemoteException{
	   InitAllData i=new InitAllData();
	   String time=""+new Date().toLocaleString();time=time.substring(0,4);
	    time="Version-"+time;
	   try {
		i.initAll(time);
//		i.copy(time);  //复制当前数据   		
//		i.recovery(time);
	} catch (ClassNotFoundException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	} catch (IOException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	}
   }
	
	public void  initAll(String time) throws RemoteException,IOException, ClassNotFoundException {
//		String path = "A";
//		File f = new File(path);
//		if(!f.exists()){
//		f.mkdirs();
//		} 
//		// fileName表示你创建的文件名；为txt类型；
//		String fileName="Storage.ser";
//		File file = new File(f,fileName);
//		if(!file.exists()){
//		try {
//		file.createNewFile();
//		} catch (IOException e) {
//		// TODO Auto-generated catch block
//		e.printStackTrace();
//		}
//		}

		//File file=new File("Storage.ser");
		Path p1=Paths.get("Version-2015","Storage.ser");
		Path p2=Paths.get("Storage.ser");
		Files.copy(p2,p1,StandardCopyOption.REPLACE_EXISTING);
//		File cfile=new File(time,time+" Storage.ser");
//		//ArrayList<StoragePO> arr=new ArrayList<StoragePO>();
//		cfile.delete();
//		FileInputStream fis=new FileInputStream(file);FileOutputStream  fos=new FileOutputStream(cfile,true);
//		ObjectInputStream ois=new ObjectInputStream(fis);ObjectOutputStream oos=new ObjectOutputStream(fos);
//		StoragePO storagepo=null;
//			storagepo=(StoragePO)ois.readObject();
//			oos.writeObject(storagepo);		
//			while(fis.available()>0){
//					byte[] buf=new byte[4];
//					fis.read(buf);
//					storagepo=(StoragePO) ois.readObject();
////					FileOutputStream fs=new FileOutputStream(cfile,true);
////					oos=new ObjectOutputStream(fs);
//				    oos.writeObject(storagepo);				
//					}
//			oos.flush();
//		    ois.close();
//		    oos.close();	    
		    setInitState();
		   //    在告知初始化前  现将现有的数据情况储存起来  然后设置初始化状态  告知初始化
	}

	public void copy(String time)  throws IOException, ClassNotFoundException{
		File file=new File("Storage.ser");
		File cfile=new File(time,"copy Storage.ser");
		cfile.delete();
		FileInputStream fis=new FileInputStream(file);FileOutputStream  fos=new FileOutputStream(cfile,true);
		ObjectInputStream ois=new ObjectInputStream(fis);ObjectOutputStream oos=new ObjectOutputStream(fos);
		StoragePO storagepo=null;
	
			storagepo=(StoragePO)ois.readObject();
			oos.writeObject(storagepo);	
			while(fis.available()>0){
					byte[] buf=new byte[4];
					fis.read(buf);
					storagepo=(StoragePO)ois.readObject();
					oos.writeObject(storagepo);				
					}		
		    ois.close();
		    oos.close();	//  备份数据     就是在各部分完成初始化构建以后   这里调用copy   将文件写到copy  ser 
	}


	public void recovery(String time) throws IOException, ClassNotFoundException {
		File file=new File("Storage.ser");
		File cfile=new File(time,"copy Storage.ser");
		file.delete();
		FileInputStream fis=new FileInputStream(cfile);FileOutputStream  fos=new FileOutputStream(file,true);
		ObjectInputStream ois=new ObjectInputStream(fis);ObjectOutputStream oos=new ObjectOutputStream(fos);
		StoragePO storagepo;
		storagepo=(StoragePO)ois.readObject();
		oos.writeObject(storagepo);	
		while(fis.available()>0){
				byte[] buf=new byte[4];
				fis.read(buf);
  
				oos.writeObject(storagepo);				
				}		
	    ois.close();
	    oos.close();	//  把当年的备份恢复    
	}


	public boolean getInitState(int a) throws RemoteException {
		switch(a){
		case 1: return initMember;
		case 2: return initCar;
		case 3: return initStorage;
		case 4: return initAccount;
		default : return false;
		}//  按照不同界面上返回的数值类型  来确定需要的值   然后确定是否进行初始化
	}

   
	public void setInitState() throws RemoteException {
		initCar=true;
		initMember=true;
		initStorage=true;
		initAccount=true;	
	}
	
	public  void  addAccount(AccountPO po) throws IOException{
		File file=new File("Account.ser");
		FileOutputStream fos=new FileOutputStream(file,true);
		ObjectOutputStream oos=new ObjectOutputStream(fos);
		oos.writeObject(po);
	    oos.close();
	}
	public ArrayList<AccountPO> getAccount() throws ClassNotFoundException, IOException{
		File file=new File("Account.ser");
		FileInputStream fis=new FileInputStream(file);
		ObjectInputStream ois=new ObjectInputStream(fis);
	    ArrayList<AccountPO> arr=new ArrayList<AccountPO>();
	    AccountPO accountpo=null;
	    accountpo=(AccountPO)ois.readObject();
	    while(fis.available()>0){
			byte[] buf =new byte[4];
			fis.read(buf);
			accountpo=(AccountPO)ois.readObject();
			arr.add(accountpo);
		}   
	    return arr;
	}
}
